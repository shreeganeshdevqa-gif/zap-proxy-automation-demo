name: Cypress + ZAP Security Scan

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  zap-cypress:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      # -----------------------------------------
      # Run Cypress first (normal run)
      # -----------------------------------------
      - name: Run Cypress tests
        run: npx cypress run --browser chrome

      # -----------------------------------------
      # Create ZAP automation file
      # FIX: Change report directory to /zap/wrk (workspace root)
      # -----------------------------------------
      - name: Create ZAP automation config
        run: |
          cat <<'EOF' > zap-automation.yaml
          env:
            contexts:
              - name: "Default Context"
                urls:
                  - "https://opensource-demo.orangehrmlive.com"
            parameters:
              progressToStdout: "true"
              failOnError: "false"
              failOnWarning: "false"

          jobs:
            - type: "spider"
              parameters:
                context: "Default Context"
                url: "https://opensource-demo.orangehrmlive.com"
                maxDuration: 3

            - type: "passiveScan-wait"
              parameters:
                maxDuration: 2

            - type: "activeScan"
              parameters:
                context: "Default Context"
                maxScanDurationInMins: 5

            - type: "report"
              parameters:
                template: "traditional-html"
                reportDir: "/zap/wrk"
                reportFile: "zap-report.html"

            - type: "report"
              parameters:
                template: "traditional-json"
                reportDir: "/zap/wrk"
                reportFile: "zap-report.json"
          EOF

      # -----------------------------------------
      # Run ZAP ONCE using Automation Framework
      # -----------------------------------------
      - name: Run ZAP Spider + Active Scan
        run: |
          # Run ZAP
          docker run --rm \
            -v ${{ github.workspace }}:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap.sh -cmd -autorun /zap/wrk/zap-automation.yaml

      # -----------------------------------------
      # Move reports to zap-reports directory
      # -----------------------------------------
      - name: Move ZAP reports to directory
        run: |
          # Create zap-reports directory if it doesn't exist
          mkdir -p zap-reports
          
          # Move ZAP reports if they were generated
          if [ -f "zap-report.html" ]; then
            mv zap-report.html zap-reports/
          fi
          
          if [ -f "zap-report.json" ]; then
            mv zap-report.json zap-reports/
          fi

      # -----------------------------------------
      # Generate Cucumber HTML report
      # -----------------------------------------
      - name: Generate Cucumber HTML report
        run: |
          mkdir -p reports/cucumber
          
          # Install the reporter package first
          npm install multiple-cucumber-html-reporter
          
          # Generate the report
          npx multiple-cucumber-html-reporter \
            --jsonDir cypress/reports/json \
            --reportPath reports/cucumber \
            --reportName "Cypress Cucumber Report"

      # -----------------------------------------
      # Upload reports
      # -----------------------------------------
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: security-and-test-reports
          path: |
            zap-reports
            reports/cucumber