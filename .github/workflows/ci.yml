name: ZAP + Cypress CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  zap-cypress:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      # -------------------------
      # Start OWASP ZAP
      # -------------------------
      - name: Start OWASP ZAP (daemon)
        run: |
          docker pull ghcr.io/zaproxy/zaproxy:stable
          docker run -d \
            --name zap \
            -p 8080:8080 \
            -p 8090:8090 \
            -v ${{ github.workspace }}/reports:/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable \
            zap.sh -daemon \
              -host 0.0.0.0 \
              -port 8080 \
              -config api.disablekey=true

      - name: Wait for ZAP to be ready
        run: sleep 20

      # -------------------------
      # Cypress via ZAP proxy
      # -------------------------
      - name: Run Cypress (Chrome via ZAP)
        env:
          CYPRESS_BASE_URL: https://opensource-demo.orangehrmlive.com
          HTTP_PROXY: http://localhost:8080
          HTTPS_PROXY: http://localhost:8080
          NO_PROXY: localhost,127.0.0.1
        run: npx cypress run --browser chrome

      # -------------------------
      # ZAP Spider Scan
      # -------------------------
      - name: ZAP Spider Scan
        run: |
          docker exec zap zap-cli spider https://opensource-demo.orangehrmlive.com
          docker exec zap zap-cli report -o /zap/wrk/zap-spider-report.html -f html

      # -------------------------
      # ZAP Active Scan
      # -------------------------
      - name: ZAP Active Scan
        run: |
          docker exec zap zap-cli active-scan https://opensource-demo.orangehrmlive.com
          docker exec zap zap-cli report -o /zap/wrk/zap-active-report.html -f html

      # -------------------------
      # Upload Reports
      # -------------------------
      - name: Upload ZAP Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: reports/

      - name: Upload Cypress Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-screenshots
          path: cypress/screenshots
