name: Cypress + ZAP Security Scan

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  zap-cypress:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      # ---------------------------
      # Start ZAP in daemon mode
      # ---------------------------
      - name: Start ZAP
        run: |
          docker run -d \
            --name zap \
            -p 8080:8080 \
            ghcr.io/zaproxy/zaproxy:stable \
            zap.sh -daemon \
            -host 0.0.0.0 \
            -port 8080 \
            -config api.disablekey=true \
            -config api.addrs.addr.name=.* \
            -config api.addrs.addr.regex=true

      - name: Wait for ZAP
        run: |
          echo "Waiting for ZAP to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:8080 >/dev/null; then
              echo "ZAP is ready"
              exit 0
            fi
            sleep 5
          done
          echo "ZAP failed to start"
          exit 1

      # ---------------------------
      # Run Cypress via ZAP proxy
      # ---------------------------
      - name: Run Cypress tests
        env:
          HTTP_PROXY: http://localhost:8080
          HTTPS_PROXY: http://localhost:8080
          NO_PROXY: localhost,127.0.0.1
        run: |
          npx cypress run --browser chrome

      # ---------------------------
      # ZAP Spider
      # ---------------------------
      - name: ZAP Spider Scan
        run: |
          docker exec zap zap-cli spider https://opensource-demo.orangehrmlive.com

      # ---------------------------
      # ZAP Active Scan
      # ---------------------------
      - name: ZAP Active Scan
        run: |
          docker exec zap zap-cli active-scan \
            https://opensource-demo.orangehrmlive.com

      # ---------------------------
      # Generate ZAP Reports
      # ---------------------------
      - name: Generate ZAP Reports
        run: |
          mkdir -p zap-reports
          docker exec zap zap-cli report \
            -o /zap/wrk/zap-report.html -f html
          docker exec zap zap-cli report \
            -o /zap/wrk/zap-report.json -f json
          docker cp zap:/zap/wrk/zap-report.html zap-reports/
          docker cp zap:/zap/wrk/zap-report.json zap-reports/

      # ---------------------------
      # Generate Cucumber HTML Report
      # ---------------------------
      - name: Generate Cucumber HTML Report
        shell: bash
        run: |
          mkdir -p reports/cucumber
          npx multiple-cucumber-html-reporter \
            --jsonDir cypress/reports/json \
            --reportPath reports/cucumber \
            --reportName "Cypress Cucumber Report"

      # ---------------------------
      # Upload Artifacts
      # ---------------------------
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-cypress-reports
          path: |
            zap-reports
            reports/cucumber
