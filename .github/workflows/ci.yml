name: Cypress + OWASP ZAP Security CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  zap-cypress:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # 1Ô∏è‚É£ Checkout repository
      # ----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------
      # 2Ô∏è‚É£ Setup Node.js
      # ----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # ----------------------------
      # 3Ô∏è‚É£ Install dependencies
      # ----------------------------
      - name: Install npm dependencies
        run: npm install

      # ----------------------------
      # 4Ô∏è‚É£ Create ZAP reports folder
      # ----------------------------
      - name: Create ZAP reports folder
        run: mkdir -p zap-reports

      # ----------------------------
      # 5Ô∏è‚É£ Start OWASP ZAP (daemon)
      # ----------------------------
      - name: Start OWASP ZAP
        run: |
          docker run -d \
            --name zap \
            -p 8080:8080 \
            -v ${{ github.workspace }}/zap-reports:/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable \
            zap.sh -daemon \
            -host 0.0.0.0 \
            -port 8080 \
            -config api.disablekey=true

      - name: Wait for ZAP to be ready
        run: sleep 25

      # ----------------------------
      # 6Ô∏è‚É£ Passive Scan (Baseline)
      # ----------------------------
      - name: ZAP Passive Scan
        run: |
          docker exec zap zap-baseline.py \
            -t https://opensource-demo.orangehrmlive.com \
            -r passive-report.html || true

      # ----------------------------
      # 7Ô∏è‚É£ Spider Scan
      # ----------------------------
      - name: ZAP Spider Scan
        run: |
          docker exec zap zap.sh -cmd \
            -quickurl https://opensource-demo.orangehrmlive.com \
            -quickout spider-report.html || true

      # ----------------------------
      # 8Ô∏è‚É£ Active Scan
      # ----------------------------
      - name: ZAP Active Scan
        run: |
          docker exec zap zap-full-scan.py \
            -t https://opensource-demo.orangehrmlive.com \
            -r active-report.html || true

      # ----------------------------
      # 9Ô∏è‚É£ Run Cypress via ZAP Proxy
      # ----------------------------
      - name: Run Cypress via ZAP Proxy
        env:
          CYPRESS_BASE_URL: https://opensource-demo.orangehrmlive.com
          HTTP_PROXY: http://localhost:8080
          HTTPS_PROXY: http://localhost:8080
          NO_PROXY: localhost,127.0.0.1
        run: npx cypress run --browser chrome

      # ----------------------------
      # üîü Upload ZAP Reports
      # ----------------------------
      - name: Upload ZAP Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-reports
          path: zap-reports/

      # ----------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ Upload Cypress Screenshots
      # ----------------------------
      - name: Upload Cypress Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-screenshots
          path: cypress/screenshots
