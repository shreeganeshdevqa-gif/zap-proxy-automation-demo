name: Cypress + ZAP Security Scan

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  zap-cypress:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------
      # Checkout repository
      # -----------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------
      # Setup Node.js
      # -----------------------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -----------------------------------------
      # Install dependencies
      # -----------------------------------------
      - name: Install dependencies
        run: npm install

      # -----------------------------------------
      # Run Cypress tests (NON-BLOCKING)
      # -----------------------------------------
      - name: Run Cypress tests
        run: npx cypress run --browser chrome
        continue-on-error: true

      # -----------------------------------------
      # Create report directories
      # -----------------------------------------
      - name: Create report directories
        run: |
          mkdir -p security-and-test-reports/zap-spider
          mkdir -p security-and-test-reports/zap-passive
          mkdir -p security-and-test-reports/zap-active

      # -----------------------------------------
      # Create ZAP Automation config
      # -----------------------------------------
      - name: Create ZAP automation config
        run: |
          cat <<'EOF' > zap-automation.yaml
          env:
            contexts:
              - name: "Default Context"
                urls:
                  - "https://opensource-demo.orangehrmlive.com"
            parameters:
              progressToStdout: "true"
              failOnError: "false"
              failOnWarning: "false"

          jobs:
            # -----------------------------
            # Spider Scan + Report
            # -----------------------------
            - type: spider
              parameters:
                context: "Default Context"
                url: "https://opensource-demo.orangehrmlive.com"
                maxDuration: 3

            - type: report
              parameters:
                template: traditional-html
                reportDir: /zap/wrk/security-and-test-reports/zap-spider
                reportFile: spider-report.html

            # -----------------------------
            # Passive Scan + Report
            # -----------------------------
            - type: passiveScan-wait
              parameters:
                maxDuration: 2

            - type: report
              parameters:
                template: traditional-html
                reportDir: /zap/wrk/security-and-test-reports/zap-passive
                reportFile: passive-report.html

            # -----------------------------
            # Active Scan + Report
            # -----------------------------
            - type: activeScan
              parameters:
                context: "Default Context"
                maxScanDurationInMins: 5

            - type: report
              parameters:
                template: traditional-html
                reportDir: /zap/wrk/security-and-test-reports/zap-active
                reportFile: active-report.html
          EOF

      # -----------------------------------------
      # Run ZAP (FORCED SUCCESS — NO ANNOTATION)
      # -----------------------------------------
      - name: Run ZAP scans
        shell: bash
        run: |
          set +e
          docker run --rm \
            --user root \
            -v ${{ github.workspace }}:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap.sh -cmd -autorun /zap/wrk/zap-automation.yaml
          echo "ZAP completed — forcing success exit"
          exit 0

      # -----------------------------------------
      # Upload ALL reports
      # -----------------------------------------
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: security-and-test-reports
          path: security-and-test-reports
